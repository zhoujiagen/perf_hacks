# BPF性能工具

- BPF Performance Tools: Linux System and Application Observability, Brendan Gregg, Addison-Wesley: 2020.

|时间|内容|
|:---------|:----------------------------------------|
| 20200710 | kick off: 添加章节标题. |

[TOC]

## 引言

程序员有时会说烹调一个补丁而不是实现一个补丁. 自学生时代我就为编程着迷. 为生成好的代码, 程序员需要选择最佳的烹调原料. 不同的编程语言提供了各种作为构建块的原料, 在Linux内核编程中, 原料只有内核本身.

在2012年, 我需要添加一组内核特性, 但我需要的原料并不存在. 我本可以开始在内核中编写构建块, 几年后才可以使用. 然而, 我决定创建通用的原料, 它在有经验的程序员手中即可以是内核中第二层的网桥也可以是第三层的路由.

我有一些重要的需求: 不管编程技巧如何, 通用的原料必须能够安全的使用. 恶意的或缺乏经验的开发者应该不能依靠它生成病毒, 通用的原料不允许发生这种事情.

Linux内核中已经有一些与称为BPF(Berkelet Packaet Filter)类似的属性: 一个最小的指令集, 用于在包被诸如tcpdump的应用看到之前过滤包. 我借用这个概念, 将我的原料命名为eBPF, 即扩展的BPF.

几年之后, eBPF与经典的BPF之间的差异已经消失了. 我的通用的原料接管了名称BPF. 一些知名的公司已经在它的基础场构建了大型系统, 为数以亿计的用户提供服务. 设计中基本的安全性原则帮助很多厨师成为世界级名厨.

第一个BPF名厨是Brendan Gregg, 他观察到在网络层的使用外, 安全的BPF可以用于性能分析、内省和观测. 构建这些工具和解释它们的度量值是需要实践和知识的.

我希望这本书将称为你最爱的菜谱, 这里你可以从主厨那儿学到如何在Linux厨房中使用BPF.

Alexei Starovoitov
Seattle, Washington
2019.8

## 序言

> “extended BPF use cases: …crazy stuff.”
> —Alexei Starovoitov, creator of the new BPF, February 2015 [1]

在2014年7月, Alexei Starovoitov访问了Netflix, 讨论他当时在开发的一个迷人的新技术: 扩展的Berkeley包过滤器(eBPF). BPF是一个名不见经传的提升包过滤性能的技术, Alexei有在包过滤场景外扩展它的想法. Alexei已经与另一个网络工程师Daniel Borkmann一起工作, 将BPF转换为一个通用的虚拟机, 能够运行高级的网络和其它程序. 这是一个令人难以置信的想法. 一个让我感兴趣的用例是性能分析工具, 我看到了BPF能够提供我所需要的编程能力. 我们达成了协议: 如果Alexei将它扩展到包过滤场景之外, 我去开发使用它的性能工具.

现在BPF可以附加到任意事件源, 已经成为系统工程中最热的新技术, 拥有众多的贡献者. 目前, 我已经开发并发布了超过70个BPF性能分析工具, 这些工具被广泛使用, 并被Netfix、Facebook等公司默认包含在服务器中. 在本书中, 我开发了另外一些工具, 还有一些其他贡献者的工具. 我很荣幸在这本书中分享这些工作, 提供给读者一些可用于性能分析、问题定位等的工具.

作为性能工程师, 我着迷于在探索中使用性能工具而不影响系统. 系统中的盲点是性能瓶颈和软件缺陷的藏身之处. 我之前的工作使用DTrace技术, 在我2011年出版的*DTrace: Dynamic Tracing in Oracle Solaris, Mac OS X, and FreeBSD*中, 我分享了我为这些操作系统开发的DTrace工具. 很兴奋现在可以分享类似的Linux工具, 而且是可做更多事情且可看到更多信息的工具.

### 为什么需要BPF性能工具?

使用BPF性能工具可以获取系统和应用中大部分的信息, 提供性能、降低成本和解决软件问题. 与传统工具相比, 它的分析更进一步, 允许在生产环境中提出任意系统问题并即时获得答案.

### 关于本书

本书是关于主要用于可观测性和性能分析的BPF工具书, 但这些工具也有其它用途: 软件问题定位、安全性分析等. 学习BPF最难的部分不是如何编写代码: 你可以在一天左右学会任意接口. 最难的部分是知道用它干什么: 应该在数以千计的可用事件中跟踪什么? 本书首先提供性能分析的必要背景知识, 然后借助BPF性能工具分析不同的软件和硬件目标系统, 并给出Netfix生产服务器的示例输出, 来帮助回答这个问题.

### 新的工具

### 关于界面

### 关于Linux版本

### 本书未涵盖的内容

### 本书是如何组织的

### 阅读对象

### 源码版权

### 补充材料和参考资料

### 本书中的约定


## PART 1: 技术

[PART 1: 技术](./bpf-book-part1.md)

## PART 2: 使用BPF工具

[PART 2: 使用BPF工具](./bpf-book-part1.md)

## PART 3: 高级主题

[PART 3: 高级主题](./bpf-book-part1.md)

## PART 4: 附录

[PART 4: 附录](./bpf-book-part1.md)
